<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Differential backup using 7-Zip for Windows (Part 2) - Secrets of batch files - 利用 7-Zip 進行差異備份（下篇） - 批次檔案的秘密 | 格物致知</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="簡介在上一篇文章 「Differential backup using 7-Zip for Windows (Part 1) - 利用 7-Zip 進行差異備份（上篇）」 中，介紹了如何利用 Open Source 軟體 7-Zip 壓縮程式，來進行差異備份。並使用 Windows/DOS 的 cmd batch 批次檔案，自動為備份檔名附加日期時間戳記。本文將繼續說明在撰寫 cmd batch">
<meta property="og:type" content="article">
<meta property="og:title" content="Differential backup using 7-Zip for Windows (Part 2) - Secrets of batch files - 利用 7-Zip 進行差異備份（下篇） - 批次檔案的秘密">
<meta property="og:url" content="https://amobiz.github.io/2012/07/22/differential-backup-using-7-zip-part2-secrets-of-batch-files/index.html">
<meta property="og:site_name" content="格物致知">
<meta property="og:description" content="簡介在上一篇文章 「Differential backup using 7-Zip for Windows (Part 1) - 利用 7-Zip 進行差異備份（上篇）」 中，介紹了如何利用 Open Source 軟體 7-Zip 壓縮程式，來進行差異備份。並使用 Windows/DOS 的 cmd batch 批次檔案，自動為備份檔名附加日期時間戳記。本文將繼續說明在撰寫 cmd batch">
<meta property="og:image" content="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67">
<meta property="og:updated_time" content="2016-06-28T03:07:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Differential backup using 7-Zip for Windows (Part 2) - Secrets of batch files - 利用 7-Zip 進行差異備份（下篇） - 批次檔案的秘密">
<meta name="twitter:description" content="簡介在上一篇文章 「Differential backup using 7-Zip for Windows (Part 1) - 利用 7-Zip 進行差異備份（上篇）」 中，介紹了如何利用 Open Source 軟體 7-Zip 壓縮程式，來進行差異備份。並使用 Windows/DOS 的 cmd batch 批次檔案，自動為備份檔名附加日期時間戳記。本文將繼續說明在撰寫 cmd batch">
<meta name="twitter:image" content="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67">
  
    <link rel="alternative" href="/atom.xml" title="格物致知" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-68633744-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">格物致知</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Happiness only real when shared.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://amobiz.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-differential-backup-using-7-zip-part2-secrets-of-batch-files" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2012/07/22/differential-backup-using-7-zip-part2-secrets-of-batch-files/" class="article-date">
  <time datetime="2012-07-21T20:55:53.000Z" itemprop="datePublished">2012-07-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Programming/">Programming</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/07/22/differential-backup-using-7-zip-part2-secrets-of-batch-files/">Differential backup using 7-Zip for Windows (Part 2) - Secrets of batch files - 利用 7-Zip 進行差異備份（下篇） - 批次檔案的秘密</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <!-- Post Contents -->
        <h3 id="簡介"><a href="#簡介" class="headerlink" title="簡介"></a>簡介</h3><p>在上一篇文章 「<a href="/2012/07/20/differential-backup-using-7-zip-part1-windows/" title="Differential backup using 7-Zip for Windows (Part 1) - 利用 7-Zip 進行差異備份（上篇）">Differential backup using 7-Zip for Windows (Part 1) - 利用 7-Zip 進行差異備份（上篇）</a>」 中，介紹了如何利用 Open Source 軟體 <a href="http://en.wikipedia.org/wiki/7-Zip" title="7-Zip" target="_blank" rel="external">7-Zip</a> 壓縮程式，來進行差異備份。並使用 Windows/DOS 的 cmd <a href="http://en.wikipedia.org/wiki/Batch_file" title="batch" target="_blank" rel="external">batch</a> 批次檔案，自動為備份檔名附加日期時間戳記。本文將繼續說明在撰寫 cmd batch 批次指令時，遇到的各種問題 (陷阱) 與解決方法。</p>
<a id="more"></a>
<a id="forkme" href="https://gist.github.com/amobiz/d0be531a7c109c785845" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" class="nofancybox"></a>
<h3 id="架構"><a href="#架構" class="headerlink" title="架構"></a>架構</h3><p>首先，以下是我慣用的批次檔檔案架構：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">  <span class="keyword">goto</span> CONFIG</span><br><span class="line"><span class="comment"></span><br><span class="line">  rem 批次檔使用與注意事項說明</span></span><br><span class="line"></span><br><span class="line">:SYNTAX</span><br><span class="line">  <span class="built_in">echo</span> Syntax: %~n0 [options] arguments</span><br><span class="line">  <span class="keyword">goto</span> END</span><br><span class="line"></span><br><span class="line">:CONFIG</span><br><span class="line">  <span class="built_in">set</span> XXX=YYY</span><br><span class="line">  gogo <span class="built_in">START</span></span><br><span class="line"></span><br><span class="line">:SUBROUTINES</span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br><span class="line"></span><br><span class="line">:<span class="built_in">START</span></span><br><span class="line"><span class="comment"></span><br><span class="line">  rem do something...</span></span><br><span class="line">  <span class="keyword">call</span> :SUBROUTINES parameters</span><br><span class="line"></span><br><span class="line">:END</span><br></pre></td></tr></table></figure>

<p>簡單說明一下：</p>
<ul>
<li>一開始就跳到 <code>:CONFIG</code> 標籤區塊。在這裡進行偏好參數的設定。</li>
<li>然後跳到 <code>:START</code> 標籤區塊，執行主程序。</li>
<li>主程序在需要的時候，利用 <code>call :LABEL</code> 的方式，呼叫副程序。</li>
<li><code>:END</code> 標籤通常是批次檔的結尾，有時候會在這個區塊設定批次檔的回傳值 (<code>ERRORLEVEL</code>)。</li>
<li><code>:START</code> 到 <code>:END</code> 之間，會盡量保持簡潔，凸顯批次檔的主要流程。</li>
</ul>
<aside class="cheatsheet"><p><strong>講古時間</strong></p>
<p>早期的 DOS 批次檔是沒有 subroutine(副程序) 功能的，所以只能用 <code>goto</code> 跳來跳去；或是利用 <code>call</code> 呼叫外部的批次檔；或是利用傳遞額外參數的技巧，遞迴呼叫自己。使用上相當不方便。而現在的呼叫副程序功能，其實是系統會動態產生一個新的批次檔，裡面包含原批次檔在該標籤之後的內容。副程序必須要執行到檔案結束，或執行 <code>exit</code> 指令，才能回到主程序。或者，可以在批次檔案結束的地方，放一個如上面 :END 標籤，供副程序直接跳到檔案結尾。不過，還有一個更好的方法，利用 <code>goto :eof</code> 的方式，跳到檔案結束的地方，這裡的 <code>:eof</code> 是內建的標籤。我傾向於使用 <code>goto :eof</code> 的方式，以凸顯此標籤區塊是一個副程序。至於其他的流程控制，還是使用 <code>goto LABEL</code> 的方式處理。</p>
</aside>
<h3 id="考慮需求"><a href="#考慮需求" class="headerlink" title="考慮需求"></a>考慮需求</h3><p>接下來，回顧一下我的備份需求：</p>
<ul>
<li>可以分類 (分開) 備份不同的目錄</li>
<li>可以自動備份常用的目錄</li>
<li>可以手動備份指定的目錄</li>
<li>可以自動為備份檔案名稱，加上時間戳記</li>
<li>可以指定進行完整備份或差異備份</li>
<li>進行完整備份時，若已有當天的完整備份，則改進行差異備份</li>
<li>進行差異備份時，若找不到完整備份，則改進行完整備份</li>
</ul>
<p>以下，我們就依據需求，逐項來分析批次檔需要完成哪些工作。</p>
<h5 id="需求：可以分類-分開-備份不同的目錄-可以自動備份常用的目錄"><a href="#需求：可以分類-分開-備份不同的目錄-可以自動備份常用的目錄" class="headerlink" title="需求：可以分類 (分開) 備份不同的目錄 + 可以自動備份常用的目錄"></a>需求：可以分類 (分開) 備份不同的目錄 + 可以自動備份常用的目錄</h5><p>這就意味著，需要一個變數，用來保存需要備份的標的，以及一個 <code>for</code> 迴圈，來分別處理這些目錄。這個簡單：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> SRC_DIR=C:\folder1, C:\folder2, &quot;C:\folder with space&quot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%F</span> <span class="keyword">in</span> (<span class="variable">%SRC_DIR%</span>) <span class="keyword">do</span> (</span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">%%F</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>輕鬆搞定。</p>
<h4 id="需求：可以手動備份指定的目錄-可以指定進行完整備份或差異備份"><a href="#需求：可以手動備份指定的目錄-可以指定進行完整備份或差異備份" class="headerlink" title="需求：可以手動備份指定的目錄 + 可以指定進行完整備份或差異備份"></a>需求：可以手動備份指定的目錄 + 可以指定進行完整備份或差異備份</h4><p>這就意味著，需要解析命令列參數。為了提供較大的彈性，指定的備份來源目錄，應該允許一次指定多個目錄，所以這是一個數量可變動的參數，最好放在參數列的後方。至於允許手動指定進行完整備份或差異備份，這比較簡單，可以分別使用 <code>FULL</code> 及 <code>DIFF</code> 參數來指定。不過，同樣為了提供彈性，應該提供預設值，讓使用者可以省略參數。</p>
<p>基於這樣的分析，我們的批次檔將提供如下的執行介面：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">7</span>z-bak [DIFF|FULL] [folders]</span><br></pre></td></tr></table></figure>

<h5 id="處理可選參數及變動參數"><a href="#處理可選參數及變動參數" class="headerlink" title="處理可選參數及變動參數"></a>處理可選參數及變動參數</h5><p>要提供上面的介面，我們將需要動態解析命令列參數。第一個版本，做了這樣的嘗試：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> &quot;FULL&quot; == &quot;%<span class="number">1</span>&quot; (</span><br><span class="line">  <span class="built_in">set</span> <span class="built_in">TYPE</span>=FULL</span><br><span class="line">  <span class="built_in">shift</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> &quot;DIFF&quot; == &quot;%<span class="number">1</span>&quot; (</span><br><span class="line">  <span class="built_in">set</span> <span class="built_in">TYPE</span>=DIFF</span><br><span class="line">  <span class="built_in">shift</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> &quot;&quot; == &quot;<span class="variable">%TYPE%</span>&quot; (</span><br><span class="line">  <span class="built_in">set</span> <span class="built_in">TYPE</span>=DIFF</span><br><span class="line">)</span><br><span class="line"><span class="built_in">set</span> DIRS=%*</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">NOT</span> &quot;&quot; == &quot;<span class="variable">%DIRS%</span>&quot; (</span><br><span class="line">  <span class="built_in">set</span> SRC_DIR=<span class="variable">%DIRS%</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>利用 <code>shift</code> 指令，可以「捲動」命令列參數，使原來的 <code>%2</code> 變成 <code>%1</code>，<code>%3</code> 變成 <code>%2</code>，依此類推。這樣，我們就可以動態判斷第一個參數是否是 <code>FULL</code> 或 <code>DIFF</code>，如果是的話，就將 <code>TYPE</code> 設定為對應的備份方式，並且將「其餘」的命令列參數，指定給 <code>DIRS</code> 變數，然後判斷 <code>DIRS</code> 變數如果不是空的，就用它來取代批次檔原來的預設值。</p>
<p>不幸的是，這樣是行不通的，原因在於 <code>%*</code> 這個參數列表示方式，它代表的是全部的命命列參數，而且，它不受 <code>shift</code> 指令的影響，永遠不會改變。所以利用 <code>shift</code> 是無法達成原來的目的：處理開頭可選的參數，並取得其餘的所有參數。</p>
<aside class="cheatsheet"><p><code>%*</code> 代表全部的命命列參數，並且是不可變的，不受 <code>shift</code> 指令影響。</p>
</aside>
<p>所以，我們必須自行遍歷所有的命令列參數，處理可選參數，並將其餘的參數，重新自行串接為一個字串，作為後續的處理。</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> PARAM=</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%F</span> <span class="keyword">in</span> (%*) <span class="keyword">do</span> (</span><br><span class="line">  <span class="keyword">if</span> &quot;FULL&quot; == &quot;<span class="variable">%%F</span>&quot; (</span><br><span class="line">    <span class="built_in">set</span> <span class="built_in">TYPE</span>=FULL</span><br><span class="line">  ) <span class="keyword">else</span> <span class="keyword">if</span> &quot;DIFF&quot; == &quot;<span class="variable">%%F</span>&quot; (</span><br><span class="line">    <span class="built_in">set</span> <span class="built_in">TYPE</span>=DIFF</span><br><span class="line">  ) <span class="keyword">else</span> (</span><br><span class="line">    <span class="keyword">if</span> &quot;&quot; == &quot;<span class="variable">%PARAM%</span>&quot; (</span><br><span class="line">      <span class="built_in">set</span> PARAM=<span class="variable">%%F</span></span><br><span class="line">    ) <span class="keyword">else</span> (</span><br><span class="line">      <span class="built_in">set</span> PARAM=<span class="variable">%PARAM%</span>, <span class="variable">%%F</span></span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">)</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">TYPE</span>=<span class="variable">%TYPE%</span></span><br><span class="line"><span class="built_in">echo</span> PARAM=<span class="variable">%PARAM%</span></span><br></pre></td></tr></table></figure>

<p>再一次，我們又遇到不幸。原來，批次檔執行的時候，系統會一次解析「一整行」指令，像上面的 <code>for</code> 迴圈，雖然以多行的方式撰寫，但是系統實際上會將它一次讀入並進行解析。同時，為了「效率」，批次檔在解析 <code>for</code> 迴圈的階段，就對變數進行展開動作。由於 <code>%PARAM%</code> 變數為空值，所以上面程式碼，就被「展開」成這樣：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> PARAM=</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%F</span> <span class="keyword">in</span> (%*) <span class="keyword">do</span> (</span><br><span class="line">  <span class="keyword">if</span> &quot;FULL&quot; == &quot;<span class="variable">%%F</span>&quot; (</span><br><span class="line">    <span class="built_in">set</span> <span class="built_in">TYPE</span>=FULL</span><br><span class="line">  ) <span class="keyword">else</span> <span class="keyword">if</span> &quot;DIFF&quot; == &quot;<span class="variable">%%F</span>&quot; (</span><br><span class="line">    <span class="built_in">set</span> <span class="built_in">TYPE</span>=DIFF</span><br><span class="line">  ) <span class="keyword">else</span> (</span><br><span class="line">    <span class="keyword">if</span> &quot;&quot; == &quot;&quot; (</span><br><span class="line">      <span class="built_in">set</span> PARAM=<span class="variable">%%F</span></span><br><span class="line">    ) <span class="keyword">else</span> (</span><br><span class="line">      <span class="built_in">set</span> PARAM=, <span class="variable">%%F</span></span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">)</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">TYPE</span>=<span class="variable">%TYPE%</span></span><br><span class="line"><span class="built_in">echo</span> PARAM=<span class="variable">%PARAM%</span></span><br></pre></td></tr></table></figure>

<p>看到了嗎，迴圈中的 <code>%PARAM%</code> 變數消失了，因為它被「展開」為空字串了。這樣一來，我們便無法在迴圈中對變數重複進行取值、設值的動作。</p>
<p>要避免這個問題，我們必須啟用「擴充功能」：<code>delayed variable expansion</code>，讓 <code>for</code> 迴圈中的變數，延遲到迴圈進行時，才被展開。這時候，在迴圈中引用變數時，要改用 <code>!PARAM!</code> 的寫法。要開啟 <code>delayed variable expansion</code> 擴充功能，可以使用 <a href="http://ss64.com/nt/setlocal.html" title="SETLOCAL" target="_blank" rel="external"><code>SETLOCAL</code></a> 指令。下面是改寫後的迴圈：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SETLOCAL</span> enabledelayedexpansion</span><br><span class="line"><span class="built_in">set</span> PARAM=</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%F</span> <span class="keyword">in</span> (%*) <span class="keyword">do</span> (</span><br><span class="line">  <span class="keyword">if</span> &quot;FULL&quot; == &quot;<span class="variable">%%F</span>&quot; (</span><br><span class="line">    <span class="built_in">set</span> <span class="built_in">TYPE</span>=FULL</span><br><span class="line">  ) <span class="keyword">else</span> <span class="keyword">if</span> &quot;DIFF&quot; == &quot;<span class="variable">%%F</span>&quot; (</span><br><span class="line">    <span class="built_in">set</span> <span class="built_in">TYPE</span>=DIFF</span><br><span class="line">  ) <span class="keyword">else</span> (</span><br><span class="line">    <span class="keyword">if</span> &quot;&quot; == &quot;<span class="variable">!PARAM!</span>&quot; (</span><br><span class="line">      <span class="built_in">set</span> PARAM=<span class="variable">%%F</span></span><br><span class="line">    ) <span class="keyword">else</span> (</span><br><span class="line">      <span class="built_in">set</span> PARAM=<span class="variable">!PARAM!</span>, <span class="variable">%%F</span></span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">)</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">TYPE</span>=<span class="variable">%TYPE%</span></span><br><span class="line"><span class="built_in">echo</span> PARAM=<span class="variable">%PARAM%</span></span><br></pre></td></tr></table></figure>

<aside class="cheatsheet"><h5>enabledelayedexpansion 擴充功能</h5><p>在 <code>for</code> 迴圈中，要使變數能夠同時進行取值及設值動作，必須啟用 <code>enabledelayedexpansion</code> 擴充功能：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SETLOCAL</span> enabledelayedexpansion</span><br></pre></td></tr></table></figure>

<p>詳細說明請參考 <a href="http://www.robvanderwoude.com/variableexpansion.php" target="_blank" rel="external">Variable Expansion in FOR Loops</a> 這篇文章。</p>
</aside>
<p>哇！真是神奇，這麼簡單的迴圈功能，都可以弄得這麼複雜。不禁開始後悔為什麼要用批次檔來處理備份了。</p>
<h5 id="改寫成-subroutine-副程序"><a href="#改寫成-subroutine-副程序" class="headerlink" title="改寫成 subroutine(副程序)"></a>改寫成 subroutine(副程序)</h5><p>由於這段程式碼是用來處理命令列參數，如果能把它獨立為一個副程序，可以讓主程序的邏輯更加清楚。另一方面，批次檔使用的變數 (環境變數)，實際上都是全域變數 -- 批次檔結束後，依舊存在 -- 至少對目前的 cmd 視窗而言。而 <code>SETLOCAL</code> 指令，實際上是要求 cmd 將變數當作區域變數使用，當批次檔結束或遇到對應的 <code>ENDLOCAL</code> 指令時，便會取消批次檔設定的變數，恢復到 SETLOCAL 之前的環境變數狀態。因此，<code>SETLOCAL</code> 與 <code>ENDLOCAL</code> 指令，經常配對使用，尤其適合放在副程序中使用，可以避免變數名稱的衝突。所以，將上面的程式片段，改寫成以下的 <code>:PARAMS</code> 標籤區塊，作為副程序，供主程序呼叫：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">:PARAMS</span><br><span class="line"><span class="built_in">SETLOCAL</span> enabledelayedexpansion</span><br><span class="line"><span class="built_in">set</span> PARAM=</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%F</span> <span class="keyword">in</span> (%*) <span class="keyword">do</span> (</span><br><span class="line">  <span class="keyword">if</span> &quot;FULL&quot; == &quot;<span class="variable">%%F</span>&quot; (</span><br><span class="line">    <span class="built_in">set</span> <span class="built_in">TYPE</span>=FULL</span><br><span class="line">  ) <span class="keyword">else</span> <span class="keyword">if</span> &quot;DIFF&quot; == &quot;<span class="variable">%%F</span>&quot; (</span><br><span class="line">    <span class="built_in">set</span> <span class="built_in">TYPE</span>=DIFF</span><br><span class="line">  ) <span class="keyword">else</span> (</span><br><span class="line">    <span class="keyword">if</span> &quot;&quot; == &quot;<span class="variable">!PARAM!</span>&quot; (</span><br><span class="line">      <span class="built_in">set</span> PARAM=<span class="variable">%%F</span></span><br><span class="line">    ) <span class="keyword">else</span> (</span><br><span class="line">      <span class="built_in">set</span> PARAM=<span class="variable">!PARAM!</span>, <span class="variable">%%F</span></span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">)</span><br><span class="line"><span class="built_in">ENDLOCAL</span> &amp; <span class="built_in">set</span> &quot;<span class="built_in">TYPE</span>=<span class="variable">%TYPE%</span>&quot; &amp; <span class="built_in">set</span> &quot;PARAM=<span class="variable">%PARAM%</span>&quot;</span><br><span class="line"><span class="keyword">goto</span> :eof</span><br></pre></td></tr></table></figure>

<p>注意上面 <code>SETLOCAL</code> 與 <code>ENDLOCAL</code> 指令配對的方式，以及 <code>ENDLOCAL</code> 指令利用 <code>&amp;</code> 指令串接 <code>set</code> 指令，回傳變數的方式。由於需要設定兩個變數，所以需要使用另一個 <code>&amp;</code> 指令串接第二個 <code>set</code> 指令。特別要注意的是，如果不像上面的範例一樣，使用 <code>set &quot;VAR=VALUE&quot;</code> 這樣的語法，將變數與值使用引號圍住，在第一個 <code>set</code> 指令後面，跟 <code>&amp;</code> 指令之間不可以有空白，否則設定的變數 (在這個例子是 <code>TYPE</code>)，會在後面多一個空白字元，導致後續判斷變數值時失敗。</p>
<aside class="cheatsheet"><h5>避免設定變數時，意外含入空白字元的方法</h5><p>要避免設定變數時，意外含入空白字元，應使用如下的語法：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> &quot;VAR=VALUE&quot;</span><br></pre></td></tr></table></figure>

<p>詳細說明請參考 <a href="http://ss64.com/nt/set.html" target="_blank" rel="external">SET</a> 這篇文章。</p>
</aside>
<aside class="cheatsheet"><h5>副程序回傳值的方式</h5><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ENDLOCAL</span> &amp; <span class="built_in">set</span> &quot;RESULT1=xxx&quot; &amp; <span class="built_in">set</span> &quot;RESULT2=yyy&quot;</span><br></pre></td></tr></table></figure>

<p>詳細說明請參考 <a href="http://ss64.com/nt/syntax-functions.html" target="_blank" rel="external">Batch file Functions</a> 這篇文章。</p>
</aside>
<h5 id="呼叫-subroutine-副程序-的方法"><a href="#呼叫-subroutine-副程序-的方法" class="headerlink" title="呼叫 subroutine (副程序) 的方法"></a>呼叫 subroutine (副程序) 的方法</h5><p>改寫成副程序之後，當然就要呼叫嘍。記得最前面提到，副程序其實是被轉成另一個批次檔來呼叫的嗎？既然實際上是另一個批次檔，它所接收到的參數，自然就不是原本的批次檔的參數了，所以主程序需要將副程序需要的參數，自行傳遞給副程序，副程序是無法看到主程序的 <code>%*</code> 參數的。另外，呼叫副程序時，不要忘了標籤前面的 <code>:</code> 號 （是的，跟 <code>goto LABEL</code> 的語法不一致）：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> :PARAMS %*</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">NOT</span> &quot;&quot; == &quot;<span class="variable">%PARAM%</span>&quot; (</span><br><span class="line">  <span class="built_in">set</span> SRC_DIR=<span class="variable">%PARAM%</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> &quot;&quot; == &quot;<span class="variable">%TYPE%</span>&quot; (</span><br><span class="line">  <span class="built_in">set</span> <span class="built_in">TYPE</span>=DIFF</span><br><span class="line">)</span><br><span class="line"><span class="built_in">echo</span> BAK_DIR=<span class="variable">%BAK_DIR%</span></span><br><span class="line"><span class="built_in">echo</span> SRC_DIR=<span class="variable">%SRC_DIR%</span></span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">TYPE</span>=<span class="variable">%TYPE%</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%F</span> <span class="keyword">in</span> (<span class="variable">%SRC_DIR%</span>) <span class="keyword">do</span> (</span><br><span class="line">  <span class="keyword">call</span> :<span class="variable">%TYPE%</span> <span class="variable">%%F</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>呼叫 <code>:PARAMS</code> 副程序後，如果 <code>%PARAM%</code> 變數不是空的，我們就用它取代原本的 <code>SRC_DIR</code> 預設值。如果 <code>%TYPE%</code> 變數是空的，我們就設定 <code>DIFF</code> 做為預設的備份模式。把這些判斷放在主程序，以便凸顯預設值可以被命令列取代。</p>
<p>然後，修改一開始寫的 <code>for</code> 迴圈，逐一呼叫由 <code>TYPE</code> 變數所代表的對應備份副程序，並將備份來源目錄當作參數傳給副程序。</p>
<aside class="cheatsheet"><p>副程序無法看到主程序的 <code>%*</code> 參數。</p>
</aside>
<aside class="cheatsheet"><p>呼叫副程序的語法是： <code>call :LABEL [parameters]</code></p>
</aside>
<aside class="cheatsheet"><p>跳轉到標籤的語法是： <code>goto LABEL</code></p>
</aside>
<h4 id="需求：可以自動為備份檔案名稱，加上時間戳記"><a href="#需求：可以自動為備份檔案名稱，加上時間戳記" class="headerlink" title="需求：可以自動為備份檔案名稱，加上時間戳記"></a>需求：可以自動為備份檔案名稱，加上時間戳記</h4><p>考慮到完整備份通常會隔好幾天才執行一次，因此完整備份的檔案名稱的時間戳記，只需要日期就足夠了。而差異備份，通常會進行得比較頻繁，即使每個小時執行一次也不為過。因此差異備份的檔案名稱的時間戳記，除了日期之外，最好再加上時間，以免檔案名稱發生衝突。</p>
<p>基於這樣的考量，將檔案名稱格式設計成下面這樣：</p>
<dl><br><dt>完整備份</dt>  <dd>[備份目錄名稱]_YEARMMDD.7z</dd><br><dt>差異備份</dt>  <dd>[備份目錄名稱]_YEARMMDD_diff_yearmmdd_hhmmss.7z</dd><br></dl>

<p>要注意到 <code>YEARMMDD</code> 是完整備份的日期戳記。由於差異備份是基於完整備份，所以需要能夠清楚區分是基於哪一個完整備份，因此差異備份將使用完整備份的檔案名稱，再附加上實際備份的日期與時間戳記。所以上面的 <code>YEARMMDD</code> 與 <code>yearmmdd</code> 很可能是不同日期。</p>
<p>決定了日期與時間戳記的格式，接下來就是設法取得正確的資料了。</p>
<p>雖然 <code>%DATE%</code> 及 <code>%TIME%</code> 可以取得日期及時間，但是格式卻不適合做為檔案名稱。同時 <code>%TIME%</code> 並不會自動補零：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="built_in">DATE</span>=&quot;<span class="variable">%DATE%</span>&quot; <span class="built_in">rem</span> &quot;<span class="number">2012</span>/<span class="number">07</span>/<span class="number">21</span> 週六&quot;</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">TIME</span>=&quot;<span class="variable">%TIME%</span>&quot; <span class="built_in">rem</span> &quot; <span class="number">2</span>:<span class="number">08</span>:<span class="number">04</span>.<span class="number">09</span>&quot;</span><br></pre></td></tr></table></figure>

<p>更糟糕的是，這跟系統使用的語系，以及使用者電腦的設定有關，每個系統的輸出可能不一致，很難正確重組格式。還好，找到了解決方案：<a href="http://stackoverflow.com/questions/203090/how-to-get-current-datetime-on-windows-command-line-in-a-suitable-format-for-us/203116#203116" title="How to get current datetime on windows command line, in a suitable format for using in a filename?" target="_blank" rel="external">How to get current datetime on windows command line, in a suitable format for using in a filename?</a> 這篇問答提供了利用 <code>wmic</code> 指令取得 ISO 時間表示的方法。我直接改寫成以下的 <code>:TIMESTAMP</code> 副程序：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:TIMESTAMP</span><br><span class="line">  <span class="built_in">SETLOCAL</span></span><br><span class="line">  <span class="keyword">for</span> /F &quot;usebackq tokens=<span class="number">1</span>,<span class="number">2</span> delims==&quot; <span class="variable">%%i</span> <span class="keyword">in</span> (<code>wmic os get LocalDateTime /VALUE &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;^&amp;gt;&lt;span class=&quot;built_in&quot;&gt;NUL&lt;/span&gt;</code>) <span class="keyword">do</span> <span class="keyword">if</span> &quot;.<span class="variable">%%i</span>.&quot;==&quot;.LocalDateTime.&quot; <span class="built_in">set</span> ldt=<span class="variable">%%j</span></span><br><span class="line">  <span class="built_in">ENDLOCAL</span> &amp; <span class="built_in">set</span> &quot;<span class="built_in">DATE</span>=<span class="variable">%ldt:~0,8%</span>&quot; &amp; <span class="built_in">set</span> &quot;<span class="built_in">TIME</span>=<span class="variable">%ldt:~8,6%</span>&quot;</span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br></pre></td></tr></table></figure>

<p>這裡的 <code>%ldt:~0,8%</code> 及 <code>%ldt:~8,6%</code> 寫法，是 substring 子字串處理的表示方式。第一個數字是由零起算的偏移位置，第二個可省略的數字是要擷取的長度。數字可以是負數，這時候就都代表由字串尾端往前計算的偏移位置。在這裡我們由 <code>ldt</code> 這個變數，分別取出日期與時間部分，設定給 <code>DATE</code> 及 <code>TIME</code> 變數。</p>
<aside class="cheatsheet"><h5>擷取子字串</h5><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">%VAR:~OFFSET,LENGTH%</span></span><br></pre></td></tr></table></figure>

<p>第一個數字 <code>OFFSET</code> 是由零起算的偏移位置，第二個可省略的數字 <code>LENGTH</code> 是要擷取的長度。數字可以是負數，這時候就都代表由字串尾端往前計算的偏移位置。</p>
<p>不過子字串處理只對 <code>%VAR%</code> 形式的變數有效，不支援命令列參數 <code>%1</code> 及 <code>for</code> 迴圈參數 <code>%%F</code> 的格式。</p>
<p>詳細語法說明，請參考 <a href="http://ss64.com/nt/syntax-substring.html" target="_blank" rel="external">Variables: extract part of a variable (substring)</a> 這篇文章。</p>
</aside>
<p>上面的程式片段裡，有一個容易引起注意的地方是，在進入迴圈前，並未啟用擴充功能，這樣不會有問題嗎？</p>
<p>由於 <code>ldt</code> 變數在迴圈中只需要被「賦值」，並不需要同時執行「取值」與「賦值」的動作，也就是說，迴圈中不需要有 <code>%ldt%</code> 的引用，自然不會發生被展開為空字串的問題。所以上面的迴圈，可以省去啟用擴充功能的動作。</p>
<p>另一方面，若迴圈中只對變數進行「取值」，並不「賦值」，同樣也不需要啟用擴充功能。為什麼呢？讀者不妨自己想想看。</p>
<p>另外，使用 <code>wmic</code> 指令的缺點是，這是 Windows XP 之後才有的指令，而且執行時需要 Administrator 權限。如果不喜歡些限制，可以改用同一篇問答的另一個答案：<a href="http://stackoverflow.com/questions/203090/how-to-get-current-datetime-on-windows-command-line-in-a-suitable-format-for-us/1951681#1951681" title="Regionaly independent date time parsing" target="_blank" rel="external">Regionaly independent date time parsing</a>，使用外部程式 date.exe 來輸出需要的格式。</p>
<p>要呼叫 <code>:TIMESTAMP</code> 副程序，可以這樣做：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> :TIMESTAMP</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">DATE</span>=&quot;<span class="variable">%DATE%</span>&quot;</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">TIME</span>=&quot;<span class="variable">%TIME%</span>&quot;</span><br><span class="line"><span class="built_in">echo</span> TIMESTAMP=&quot;<span class="variable">%DATE%</span>_<span class="variable">%TIME%</span>&quot;</span><br></pre></td></tr></table></figure>

<p>我們把這個呼叫放在主程序的 <code>for</code> 迴圈之前，以便初始化 <code>DATE</code> 及 <code>TIME</code> 變數，供後面的程式使用。另外，由於有許多副程序都需要啟用擴充功能，乾脆在主程序直接啟用吧：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">:<span class="built_in">START</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">SETLOCAL</span> enabledelayedexpansion</span><br><span class="line"></span><br><span class="line">  <span class="keyword">call</span> :PARAMS %*</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">NOT</span> &quot;&quot; == &quot;<span class="variable">%PARAM%</span>&quot; (</span><br><span class="line">    <span class="built_in">set</span> SRC_DIR=<span class="variable">%PARAM%</span></span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">if</span> &quot;&quot; == &quot;<span class="variable">%TYPE%</span>&quot; (</span><br><span class="line">    <span class="built_in">set</span> <span class="built_in">TYPE</span>=DIFF</span><br><span class="line">  )</span><br><span class="line">  <span class="built_in">echo</span> BAK_DIR=<span class="variable">%BAK_DIR%</span></span><br><span class="line">  <span class="built_in">echo</span> SRC_DIR=<span class="variable">%SRC_DIR%</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="built_in">TYPE</span>=<span class="variable">%TYPE%</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">call</span> :TIMESTAMP</span><br><span class="line">  <span class="built_in">echo</span> <span class="built_in">DATE</span>: &quot;<span class="variable">%DATE%</span>&quot;</span><br><span class="line">  <span class="built_in">echo</span> <span class="built_in">TIME</span>: &quot;<span class="variable">%TIME%</span>&quot;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> <span class="variable">%%F</span> <span class="keyword">in</span> (<span class="variable">%SRC_DIR%</span>) <span class="keyword">do</span> (</span><br><span class="line">    <span class="keyword">call</span> :<span class="variable">%TYPE%</span> <span class="variable">%%F</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">:END</span><br></pre></td></tr></table></figure>

<h4 id="需求：進行完整備份時，若已有當天的完整備份，則改進行差異備份"><a href="#需求：進行完整備份時，若已有當天的完整備份，則改進行差異備份" class="headerlink" title="需求：進行完整備份時，若已有當天的完整備份，則改進行差異備份"></a>需求：進行完整備份時，若已有當天的完整備份，則改進行差異備份</h4><p>當進行完整備份時，我們要能夠判斷當天的完整備份檔案是否已經存在，這個簡單，只要確認 <code>[備份目錄名稱]_%DATE%.7z</code> 檔案是否存在就成了。以下就是 <code>:FULL</code> 副程序：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">:FULL</span><br><span class="line">  <span class="built_in">SETLOCAL</span></span><br><span class="line">  <span class="built_in">set</span> SRC=%<span class="number">1</span></span><br><span class="line">  <span class="built_in">set</span> FN=%~nx1</span><br><span class="line">  <span class="built_in">echo</span> ------------------</span><br><span class="line">  <span class="built_in">echo</span> Requesting full backup <span class="keyword">for</span> &quot;<span class="variable">%SRC%</span>&quot;...</span><br><span class="line">  <span class="built_in">set</span> FB=<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span><span class="variable">%DATE%</span>.<span class="number">7</span>z</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">EXIST</span> <span class="variable">%FB%</span> (</span><br><span class="line">    <span class="built_in">echo</span> ...full backup <span class="keyword">for</span> &quot;<span class="variable">%SRC%</span>&quot;: <span class="variable">%FB%</span> already <span class="keyword">exist</span>, re-request diff backup instead...</span><br><span class="line">    <span class="keyword">call</span> :DO_DIFF_BAK <span class="variable">%SRC%</span> <span class="variable">%FB%</span></span><br><span class="line">  ) <span class="keyword">else</span> (</span><br><span class="line">    <span class="keyword">call</span> :DO_FULL_BAK <span class="variable">%SRC%</span> <span class="variable">%FB%</span></span><br><span class="line">  )</span><br><span class="line">  <span class="built_in">ENDLOCAL</span></span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br><span class="line"></span><br><span class="line">:DO_FULL_BAK</span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br><span class="line"></span><br><span class="line">:DO_DIFF_BAK</span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br></pre></td></tr></table></figure>

<p>這個副程序接受一個參數，並將它儲存在 <code>SRC</code> 變數，這個參數代表要備份的目錄，格式是 <code>D:\some_parent_dir\backup_dir.ext</code>。</p>
<p>另外，也同時將這個參數，只取出檔名的部分，儲存在 <code>FN</code> 變數，在這個例子，就是 <code>backup_dir.ext</code>。其中 <code>~n</code> 及 <code>~x</code> 表示方式，是取出路徑中的檔案名稱及副檔名，可以合併寫成 <code>~nx</code>。由於路徑參數處理只能用於參數，無法用於 <code>%VAR%</code> 形式的字串變數，所以必須直接對 <code>%1</code> 進行操作，不能由 <code>SRC</code> 變數取得。</p>
<aside class="cheatsheet"><h5>路徑參數</h5><p>路徑參數處理只能用於參數，包括：命令列參數、副程序參數、<code>for</code> 迴圈參數。</p>
<p>關於路徑參數的使用說明，請參考 <a href="http://ss64.com/nt/syntax-args.html" target="_blank" rel="external">Parameters</a> 這篇文章。</p>
</aside>
<p>接下來，將 <code>FB</code> 變數設定為完整備份檔案的完整路徑名稱，然後檢查檔案是否存在。如果檔案存在，則呼叫 <code>:DO_DIFF_BAK</code> 改為進行差異備份；否則，則呼叫 <code>:DO_FULL_BAK</code> 繼續進行完整備份。呼叫副程序時，傳入要備份的目錄 <code>%SRC%</code>，以及完整備份檔案名稱 <code>%FB%</code> 作為參數：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> FB=<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span><span class="variable">%DATE%</span>.<span class="number">7</span>z</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">EXIST</span> <span class="variable">%FB%</span> (</span><br><span class="line">  <span class="keyword">call</span> :DO_DIFF_BAK <span class="variable">%SRC%</span> <span class="variable">%FB%</span></span><br><span class="line">) <span class="keyword">else</span> (</span><br><span class="line">  <span class="keyword">call</span> :DO_FULL_BAK <span class="variable">%SRC%</span> <span class="variable">%FB%</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="需求：進行差異備份時，若找不到完整備份，則改進行完整備份"><a href="#需求：進行差異備份時，若找不到完整備份，則改進行完整備份" class="headerlink" title="需求：進行差異備份時，若找不到完整備份，則改進行完整備份"></a>需求：進行差異備份時，若找不到完整備份，則改進行完整備份</h4><p>當進行差異備份時，我們要能夠找出最新的完整備份檔案，才能在該完整備份檔案的基礎上，進行差異備份。所以，這裡的問題是，要如何找到最新的完整備份檔案呢？</p>
<p>由於已經將完整備份檔案名稱固定為 <code>[備份目錄名稱]_YEARMMDD.7z</code> 這樣的格式，而 wildcard 通配字元 <code>?</code> 只會匹配一個字元，所以利用 <code>[備份目錄名稱]_????????.7z</code> 這樣的格式，理論上應該能匹配檔案名稱只含有日期戳記 8 個數字的檔案，也就是只會批配完整備份檔案。同時，由於 <code>for</code> 迴圈在處理檔案匹配時，是依照檔案名稱排序，而我們的檔案名稱含有日期戳記，所以匹配的最後一個檔案，應該就是最新的完整備份檔案：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> SRC=%<span class="number">1</span></span><br><span class="line"><span class="built_in">set</span> FN=%~nx1</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%F</span> <span class="keyword">in</span> (<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span>????????.<span class="number">7</span>z) <span class="keyword">do</span> (</span><br><span class="line">  <span class="built_in">set</span> FULL=<span class="variable">%%F</span></span><br><span class="line">)</span><br><span class="line"><span class="built_in">echo</span> &quot;found: <span class="variable">%FULL%</span>&quot;</span><br></pre></td></tr></table></figure>

<p>但是，很不幸地，實際上測試結果，它還是會批配到 <code>[備份目錄名稱]_????????_diff_????????_??????.7z</code> 的檔案，也就是找到差異備份檔案了。為什麼呢？原來通配字元會同時檢測「長檔名」與「短檔名」。我想，沒有經歷過 Windows 95/98/ME 的讀者，甚至於不知道什麼是「短檔名」吧？歐賣尬！</p>
<aside class="cheatsheet"><h5>通配字元會同時檢測「長檔名」與「短檔名」</h5><p>通配字元 <code>?</code> 及 <code>*</code> 會同時檢測「長檔名」與「短檔名」。在 <code>for</code> 迴圈中及 <code>dir</code> 指令皆然。</p>
<p></p><p>關於通配字元的說明，請參考 <a href="http://ss64.com/nt/syntax-wildcards.html" target="_blank" rel="external">Wildcards</a> 這篇文章。</p>
<p>關於「長檔名」與「短檔名」的說明，請參考 <a href="http://ss64.com/nt/syntax-filenames.html" target="_blank" rel="external">Long filenames, NTFS and legal filename characters</a> 這篇文章。</p>
</aside>
<p>沒辦法，只好自己過濾了：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">:DIFF</span><br><span class="line">  <span class="built_in">SETLOCAL</span></span><br><span class="line">  <span class="built_in">set</span> SRC=%<span class="number">1</span></span><br><span class="line">  <span class="built_in">set</span> FN=%~nx1</span><br><span class="line">  <span class="built_in">echo</span> ------------------</span><br><span class="line">  <span class="built_in">echo</span> Requesting diff backup <span class="keyword">for</span> &quot;<span class="variable">%SRC%</span>&quot;...</span><br><span class="line">  <span class="built_in">echo</span> ...finding full backup...</span><br><span class="line">  <span class="built_in">set</span> FB=</span><br><span class="line">  <span class="keyword">for</span> <span class="variable">%%N</span> <span class="keyword">in</span> (<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span>*.<span class="number">7</span>z) <span class="keyword">do</span> (</span><br><span class="line">    <span class="built_in">set</span> STMP=<span class="variable">%%N</span></span><br><span class="line">    <span class="built_in">set</span> STMP=<span class="variable">!STMP:~-11,8!</span></span><br><span class="line">    <span class="keyword">if</span> &quot;<span class="variable">%%N</span>&quot; == &quot;<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span><span class="variable">!STMP!</span>.<span class="number">7</span>z&quot; (</span><br><span class="line">      <span class="built_in">echo</span> ......found: <span class="variable">%%N</span></span><br><span class="line">      <span class="built_in">set</span> FB=<span class="variable">%%N</span></span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">if</span> &quot;&quot; == &quot;<span class="variable">%FB%</span>&quot; (</span><br><span class="line">    <span class="built_in">echo</span> ...full backup <span class="keyword">not</span> found, re-request full backup instead...</span><br><span class="line">    <span class="keyword">call</span> :DO_FULL_BAK <span class="variable">%SRC%</span> &quot;<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span><span class="variable">%DATE%</span>.<span class="number">7</span>z&quot;</span><br><span class="line">  ) <span class="keyword">else</span> (</span><br><span class="line">    <span class="built_in">echo</span> ...full backup found: <span class="variable">%FB%</span></span><br><span class="line">    <span class="keyword">call</span> :DO_DIFF_BAK <span class="variable">%SRC%</span> <span class="variable">%FB%</span></span><br><span class="line">  )</span><br><span class="line">  <span class="built_in">ENDLOCAL</span></span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br></pre></td></tr></table></figure>

<p>利用擷取子字串的方式，擷取不含副檔名 (去掉 <code>.7z</code>) 的檔案名稱最後 8 個字元，並且重新依照完整備份的檔案名稱格式，重新拼湊出檔名。如果拼湊出來的檔案名稱與迴圈抓到的檔案名稱一致，就表示這個檔案確實是完整備份(差異備份檔案名稱最後 8 個字元應該是 <code>8_888888</code> 的格式，不會是 <code>88888888</code> 的格式)，那麼，就記錄在 <code>FB</code> 變數。待迴圈執行完畢，就能得到最新的完整備份檔案名稱了。</p>
<p>然後，判斷如果 <code>FB</code> 為空字串，表示找不到任何完整備份檔，則呼叫 <code>:DO_FULL_BAK</code>，改進行完整備份；否則呼叫 <code>:DO_DIFF_BAK</code>，執行差異備份。呼叫副程序時，傳入要備份的目錄 <code>%SRC%</code>，以及完整備份檔案名稱 <code>%BAK_DIR%\%FN%_%DATE%.7z</code> 或 <code>%FB%</code> 作為參數：</p>
<h4 id="處理-7-Zip-壓縮共用選項"><a href="#處理-7-Zip-壓縮共用選項" class="headerlink" title="處理 7-Zip 壓縮共用選項"></a>處理 7-Zip 壓縮共用選項</h4><p>困難的部分差不多都處理完了...吧？在實際呼叫 7-Zip 執行壓縮之前，先設定一下壓縮的選項，以避免重複：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> <span class="number">7</span>Z_OPT=-scsUTF-<span class="number">8</span> -ssc -ssw -ms=on -mx=<span class="number">9</span> -t7z</span><br></pre></td></tr></table></figure>

<p>唉！又踩到地雷了。變數名稱不能以數字開頭，否則會被當作命令列參數。是自己大意，摸摸鼻子就算了：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> Z_OPT=-scsUTF-<span class="number">8</span> -ssc -ssw -ms=on -mx=<span class="number">9</span> -t7z</span><br></pre></td></tr></table></figure>

<aside class="cheatsheet"><h5>變數名稱不能以數字開頭</h5><p>變數名稱不能以數字開頭，否則會被當作命令列參數。</p>
</aside>
<p>下表一一說明這些選項的作用：</p>
<p><strong>7-Zip 壓縮選項</strong></p>
<table>
<thead>
<tr>
<th>選項</th>
<th>說明</th>
<th>預設值</th>
<th>備註</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>-scsUTF-8</strong></td>
<td>檔名列表使用 UTF-8 編碼</td>
<td>預設開啟</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>-ssc</strong></td>
<td>維持檔名大小寫</td>
<td>在 Windows 預設關閉</td>
<td>Java 開發者應該知道為什麼要打開這個選項</td>
<td></td>
</tr>
<tr>
<td><strong>-ssw</strong></td>
<td>壓縮被其它程式鎖住的檔案</td>
<td>預設關閉</td>
<td>自動執行備份的時候，很可能還有其他程式正打開要備份的檔案</td>
<td></td>
</tr>
<tr>
<td><strong>-ms=on</strong></td>
<td>Solid Archive 把所有的檔案壓在一起，可以提高壓縮率</td>
<td>預設開啟</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>-mx=9</strong></td>
<td>壓縮率設定為最大</td>
<td>預設為 5</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>-t7z</strong></td>
<td>使用 7z 格式</td>
<td>預設由副檔名決定</td>
<td>只有 7z 格式支援差異備份</td>
<td></td>
</tr>
</tbody>
</table>
<p>要特別說明的是，由於我們每次進行差異備份的時候，都將建立新的檔案，並不會更動到原有的壓縮檔，不會有需要耗時重新壓縮的問題，所以可以使用 -ms=on 選項，打開 Solid Archive 功能，提高壓縮率。-ms=on 選項是預設開啟的，不過把它寫出來，強調我們要啟用這個選項。</p>
<aside class="cheatsheet"><h5>7-Zip 的命令列參數</h5><p>關於 7-Zip 的命令列參數的詳細說明，請參考 <a href="http://www.dotnetperls.com/7-zip-examples" target="_blank" rel="external">7-Zip Command-Line</a> 這篇文章。</p>
<p>不過，最完整的說明，還是要看 <a href="http://www.7-zip.org/download.html" target="_blank" rel="external">7-Zip 或 7za</a> 下載包裡面的 7-zip.chm 說明檔案了。</p>
</aside>
<h4 id="呼叫-7-Zip-執行完整備份"><a href="#呼叫-7-Zip-執行完整備份" class="headerlink" title="呼叫 7-Zip 執行完整備份"></a>呼叫 7-Zip 執行完整備份</h4><p>完整備份比較簡單，只要決定好檔案名稱及備份目錄，再以 <code>a</code> 命令呼叫 <code>7za.exe</code> 即可。</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">:DO_FULL_BAK</span><br><span class="line">  <span class="built_in">SETLOCAL</span></span><br><span class="line">  <span class="built_in">set</span> <span class="built_in">DIR</span>=%<span class="number">1</span></span><br><span class="line">  <span class="built_in">set</span> FULL=%<span class="number">2</span></span><br><span class="line">  <span class="built_in">echo</span> ...performing full backup...</span><br><span class="line">  <span class="number">7</span>za a <span class="variable">%FULL%</span> <span class="variable">%Z_OPT%</span> <span class="variable">%DIR%</span></span><br><span class="line">  <span class="built_in">echo</span> .</span><br><span class="line">  <span class="built_in">echo</span> ...<span class="variable">%FULL%</span>...done.</span><br><span class="line">  <span class="built_in">ENDLOCAL</span></span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br></pre></td></tr></table></figure>

<p>此副程序接受兩個參數，<code>%1</code> 是要備份的目錄，<code>%2</code> 是完整備份的檔案名稱。養成好習慣，把參數指定給比較容易辨識的變數名稱 <code>DIR</code> 與 <code>FULL</code>，讓程式比較容易讀懂。</p>
<h4 id="呼叫-7-Zip-執行差異備份"><a href="#呼叫-7-Zip-執行差異備份" class="headerlink" title="呼叫 7-Zip 執行差異備份"></a>呼叫 7-Zip 執行差異備份</h4><p>差異備份要使用 <code>u</code> 命令呼叫 <code>7za.exe</code>，為了要能忠實反映檔案的增刪異動情形，並且將異動情形儲存在獨立的差異備份檔案中，則要再加上 <code>-u- -up0q3r2x2y2z0w2![差異備份檔案名稱]</code> 選項：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">:DO_DIFF_BAK</span><br><span class="line">  <span class="built_in">SETLOCAL</span></span><br><span class="line">  <span class="built_in">set</span> <span class="built_in">DIR</span>=%<span class="number">1</span></span><br><span class="line">  <span class="built_in">set</span> FULL=%<span class="number">2</span></span><br><span class="line">  <span class="built_in">set</span> DIFF=&quot;<span class="variable">%FULL:~0,-3%</span><em>diff</em><span class="variable">%DATE%</span>_<span class="variable">%TIME%</span>.<span class="number">7</span>z&quot;</span><br><span class="line">  <span class="built_in">echo</span> ...performing diff backup on <span class="variable">%FULL%</span>...</span><br><span class="line">  <span class="number">7</span>za u <span class="variable">%FULL%</span> <span class="variable">%Z_OPT%</span> -u- -up0q3r2x2y2z0w2^^!<span class="variable">%DIFF%</span> <span class="variable">%DIR%</span></span><br><span class="line">  <span class="built_in">echo</span> .</span><br><span class="line">  <span class="built_in">echo</span> ...<span class="variable">%DIFF%</span>...done^^!</span><br><span class="line">  <span class="built_in">ENDLOCAL</span></span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br></pre></td></tr></table></figure>

<p>其中 <code>-u-</code> 選項，是告訴 7-Zip 不要更動 <code>%FULL%</code> 檔案。而 <code>-up0q3r2x2y2z0w2!%DIFF%</code> 是告訴 7-Zip 將異動的部分，放到 <code>%DIFF%</code> 檔案中。</p>
<aside class="cheatsheet"><h5>7-Zip&nbsp;的差異備份選項</h5><p>關於 7-Zip 差異備份選項的介紹，請參考 <a href="http://a32.me/2010/08/7zip-differential-backup-linux-windows/" target="_blank" rel="external">Automated differential backup using 7zip for linux/windows</a> 這篇文章。</p>
</aside>
<p>如前面檔案名稱設計那一段所述，差異備份的檔案名稱，是使用對應的完整備份的檔案名稱，再附加上實際備份的日期與時間戳記，所以只要去掉 <code>FULL</code> 變數的 <code>.7z</code> 副檔名，再附加上 <code>_diff_%DATE%_%TIME%.7z</code> 就是差異備份的檔案名稱了。</p>
<p>等一下！那個兩個 <code>^^</code> 是什麼鬼！？</p>
<p>記得我們在主程序啟用了擴充功能嗎？現在就要為此付出代價了：</p>
<p>由於啟用擴充功能之後，變數須改用 <code>!VAR!</code> 的形式引用，這時候 <code>!</code> 就有了特殊意義，因此若要讓 <code>!</code> 被當作一般字元使用，就需要使用 <code>^^</code> 對它進行 escape 轉義！</p>
<aside class="cheatsheet"><h5>啟用擴充功能後的『!』字元使用</h5><p>啟用擴充功能後，要使 <code>!</code> 作為一般字元使用，則必須使用 <code>^^</code> 對它進行 escape 轉義。</p>
<p>詳細說明請參考 <a href="http://stackoverflow.com/questions/3288552/how-can-i-escape-an-exclamation-mark-in-cmd-scripts" target="_blank" rel="external">How can I escape an exclamation mark ! in cmd scripts?</a> 這篇問答。</p>
</aside>
<h3 id="初步的成果"><a href="#初步的成果" class="headerlink" title="初步的成果"></a>初步的成果</h3><p>把全部的程式碼整理在一起，下面就是可以處理備份功能的批次檔了：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off &amp; <span class="keyword">goto</span> CONFIG</span><br><span class="line"></span><br><span class="line">:SYNTAX</span><br><span class="line"></span><br><span class="line">  <span class="built_in">echo</span> Syntax: %~n0 [DIFF|FULL] [folders]</span><br><span class="line">  <span class="keyword">goto</span> END</span><br><span class="line"></span><br><span class="line">:CONFIG</span><br><span class="line"></span><br><span class="line">  <span class="built_in">set</span> BAK_DIR=[你要儲存備份檔的目錄，不要包含路徑最後的 \ 字元]</span><br><span class="line">  <span class="built_in">set</span> SRC_DIR=[你要備份的目錄，不要包含路徑最後的 \ 字元。用空格或逗號區隔不同目錄。如果目錄包含空白字元，請使用 &quot;&quot; 括住完整路目錄名稱]</span><br><span class="line"></span><br><span class="line">  <span class="built_in">set</span> Z_OPT=-scsUTF-<span class="number">8</span> -ssc -ssw -ms=on -mx=<span class="number">9</span> -t7z</span><br><span class="line"></span><br><span class="line">  <span class="keyword">goto</span> <span class="built_in">START</span></span><br><span class="line"></span><br><span class="line">:PARAMS</span><br><span class="line">  <span class="built_in">SETLOCAL</span></span><br><span class="line">  <span class="built_in">set</span> PARAM=</span><br><span class="line">  <span class="keyword">for</span> <span class="variable">%%F</span> <span class="keyword">in</span> (%<em>) <span class="keyword">do</span> (</em></span><br><span class="line">    <span class="keyword">if</span> &quot;FULL&quot; == &quot;<span class="variable">%%F</span>&quot; (</span><br><span class="line">      <span class="built_in">set</span> <span class="built_in">TYPE</span>=FULL</span><br><span class="line">    ) <span class="keyword">else</span> <span class="keyword">if</span> &quot;DIFF&quot; == &quot;<span class="variable">%%F</span>&quot; (</span><br><span class="line">      <span class="built_in">set</span> <span class="built_in">TYPE</span>=DIFF</span><br><span class="line">    ) <span class="keyword">else</span> (</span><br><span class="line">      <span class="keyword">if</span> &quot;&quot; == &quot;<span class="variable">!PARAM!</span>&quot; (</span><br><span class="line">        <span class="built_in">set</span> PARAM=<span class="variable">%%F</span></span><br><span class="line">      ) <span class="keyword">else</span> (</span><br><span class="line">        <span class="built_in">set</span> PARAM=<span class="variable">!PARAM!</span>, <span class="variable">%%F</span></span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  <span class="built_in">ENDLOCAL</span> &amp; <span class="built_in">set</span> &quot;<span class="built_in">TYPE</span>=<span class="variable">%TYPE%</span>&quot; &amp; <span class="built_in">set</span> &quot;PARAM=<span class="variable">%PARAM%</span>&quot;</span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br><span class="line"></span><br><span class="line">:TIMESTAMP</span><br><span class="line">  <span class="built_in">SETLOCAL</span></span><br><span class="line">  <span class="keyword">for</span> /F &quot;usebackq tokens=<span class="number">1</span>,<span class="number">2</span> delims==&quot; <span class="variable">%%i</span> <span class="keyword">in</span> (<code>wmic os get LocalDateTime /VALUE &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;^&amp;gt;&lt;span class=&quot;built_in&quot;&gt;NUL&lt;/span&gt;</code>) <span class="keyword">do</span> <span class="keyword">if</span> &quot;.<span class="variable">%%i</span>.&quot;==&quot;.LocalDateTime.&quot; <span class="built_in">set</span> ldt=<span class="variable">%%j</span></span><br><span class="line">  <span class="built_in">ENDLOCAL</span> &amp; <span class="built_in">set</span> &quot;<span class="built_in">DATE</span>=<span class="variable">%ldt:~0,8%</span>&quot; &amp; <span class="built_in">set</span> &quot;<span class="built_in">TIME</span>=<span class="variable">%ldt:~8,6%</span>&quot;</span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br><span class="line"></span><br><span class="line">:DO_FULL_BAK</span><br><span class="line">  <span class="built_in">SETLOCAL</span></span><br><span class="line">  <span class="built_in">set</span> <span class="built_in">DIR</span>=%<span class="number">1</span></span><br><span class="line">  <span class="built_in">set</span> FULL=%<span class="number">2</span></span><br><span class="line">  <span class="built_in">echo</span> ...performing full backup...</span><br><span class="line">  <span class="number">7</span>za a <span class="variable">%FULL%</span> <span class="variable">%Z_OPT%</span> <span class="variable">%DIR%</span></span><br><span class="line">  <span class="built_in">echo</span> .</span><br><span class="line">  <span class="built_in">echo</span> ...<span class="variable">%FULL%</span>...done^^!</span><br><span class="line">  <span class="built_in">ENDLOCAL</span></span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br><span class="line"></span><br><span class="line">:DO_DIFF_BAK</span><br><span class="line">  <span class="built_in">SETLOCAL</span></span><br><span class="line">  <span class="built_in">set</span> <span class="built_in">DIR</span>=%<span class="number">1</span></span><br><span class="line">  <span class="built_in">set</span> FULL=%<span class="number">2</span></span><br><span class="line">  <span class="built_in">set</span> DIFF=&quot;<span class="variable">%FULL:~0,-3%</span><em>diff</em><span class="variable">%DATE%</span>_<span class="variable">%TIME%</span>.<span class="number">7</span>z&quot;</span><br><span class="line">  <span class="built_in">echo</span> ...performing diff backup on <span class="variable">%FULL%</span>...</span><br><span class="line">  <span class="number">7</span>za u <span class="variable">%FULL%</span> <span class="variable">%Z_OPT%</span> -u- -up0q3r2x2y2z0w2^^!<span class="variable">%DIFF%</span> <span class="variable">%DIR%</span></span><br><span class="line">  <span class="built_in">echo</span> .</span><br><span class="line">  <span class="built_in">echo</span> ...<span class="variable">%DIFF%</span>...done^^!</span><br><span class="line">  <span class="built_in">ENDLOCAL</span></span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br><span class="line"></span><br><span class="line">:FULL</span><br><span class="line">  <span class="built_in">SETLOCAL</span></span><br><span class="line">  <span class="built_in">set</span> SRC=%<span class="number">1</span></span><br><span class="line">  <span class="built_in">set</span> FN=%~nx1</span><br><span class="line">  <span class="built_in">echo</span> ------------------</span><br><span class="line">  <span class="built_in">echo</span> Requesting full backup <span class="keyword">for</span> &quot;<span class="variable">%SRC%</span>&quot;...</span><br><span class="line">  <span class="built_in">set</span> FB=&quot;<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span><span class="variable">%DATE%</span>.<span class="number">7</span>z&quot;</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">EXIST</span> <span class="variable">%FB%</span> (</span><br><span class="line">    <span class="built_in">echo</span> ...full backup <span class="keyword">for</span> &quot;<span class="variable">%SRC%</span>&quot;: <span class="variable">%FB%</span> already <span class="keyword">exist</span>, re-request diff backup instead...</span><br><span class="line">    <span class="keyword">call</span> :DO_DIFF_BAK <span class="variable">%SRC%</span> <span class="variable">%FB%</span></span><br><span class="line">  ) <span class="keyword">else</span> (</span><br><span class="line">    <span class="keyword">call</span> :DO_FULL_BAK <span class="variable">%SRC%</span> <span class="variable">%FB%</span></span><br><span class="line">  )</span><br><span class="line">  <span class="built_in">ENDLOCAL</span></span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br><span class="line"></span><br><span class="line">:DIFF</span><br><span class="line">  <span class="built_in">SETLOCAL</span></span><br><span class="line">  <span class="built_in">set</span> SRC=%<span class="number">1</span></span><br><span class="line">  <span class="built_in">set</span> FN=%~nx1</span><br><span class="line">  <span class="built_in">echo</span> ------------------</span><br><span class="line">  <span class="built_in">echo</span> Requesting diff backup <span class="keyword">for</span> &quot;<span class="variable">%SRC%</span>&quot;...</span><br><span class="line">  <span class="built_in">echo</span> ...finding full backup...</span><br><span class="line">  <span class="built_in">set</span> FB=</span><br><span class="line">  <span class="keyword">for</span> <span class="variable">%%N</span> <span class="keyword">in</span> (<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span>.<span class="number">7</span>z) <span class="keyword">do</span> (</span><br><span class="line">    <span class="built_in">set</span> STMP=<span class="variable">%%N</span></span><br><span class="line">    <span class="built_in">set</span> STMP=<span class="variable">!STMP:~-11,8!</span></span><br><span class="line">    <span class="keyword">if</span> &quot;<span class="variable">%%N</span>&quot; == &quot;<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span><span class="variable">!STMP!</span>.<span class="number">7</span>z&quot; (</span><br><span class="line">      <span class="built_in">echo</span> ......found: <span class="variable">%%N</span></span><br><span class="line">      <span class="built_in">set</span> FB=<span class="variable">%%N</span></span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">if</span> &quot;&quot; == &quot;<span class="variable">%FB%</span>&quot; (</span><br><span class="line">    <span class="built_in">echo</span> ...full backup <span class="keyword">not</span> found, re-request full backup instead...</span><br><span class="line">    <span class="keyword">call</span> :DO_FULL_BAK <span class="variable">%SRC%</span> &quot;<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span><span class="variable">%DATE%</span>.<span class="number">7</span>z&quot;</span><br><span class="line">  ) <span class="keyword">else</span> (</span><br><span class="line">    <span class="built_in">echo</span> ...full backup found: <span class="variable">%FB%</span></span><br><span class="line">    <span class="keyword">call</span> :DO_DIFF_BAK <span class="variable">%SRC%</span> <span class="variable">%FB%</span></span><br><span class="line">  )</span><br><span class="line">  <span class="built_in">ENDLOCAL</span></span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br><span class="line"></span><br><span class="line">:<span class="built_in">START</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">SETLOCAL</span> enabledelayedexpansion</span><br><span class="line"></span><br><span class="line">  <span class="keyword">call</span> :PARAMS %*</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">NOT</span> &quot;&quot; == &quot;<span class="variable">%PARAM%</span>&quot; (</span><br><span class="line">    <span class="built_in">set</span> SRC_DIR=<span class="variable">%PARAM%</span></span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">if</span> &quot;&quot; == &quot;<span class="variable">%TYPE%</span>&quot; (</span><br><span class="line">    <span class="built_in">set</span> <span class="built_in">TYPE</span>=DIFF</span><br><span class="line">  )</span><br><span class="line">  <span class="built_in">echo</span> BAK_DIR=<span class="variable">%BAK_DIR%</span></span><br><span class="line">  <span class="built_in">echo</span> SRC_DIR=<span class="variable">%SRC_DIR%</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="built_in">TYPE</span>=<span class="variable">%TYPE%</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">call</span> :TIMESTAMP</span><br><span class="line">  <span class="built_in">echo</span> <span class="built_in">DATE</span>: &quot;<span class="variable">%DATE%</span>&quot;</span><br><span class="line">  <span class="built_in">echo</span> <span class="built_in">TIME</span>: &quot;<span class="variable">%TIME%</span>&quot;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> <span class="variable">%%F</span> <span class="keyword">in</span> (<span class="variable">%SRC_DIR%</span>) <span class="keyword">do</span> (</span><br><span class="line">    <span class="keyword">call</span> :<span class="variable">%TYPE%</span> <span class="variable">%%F</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">:END</span><br></pre></td></tr></table></figure>

<h4 id="處理目錄名稱含有空白的情形"><a href="#處理目錄名稱含有空白的情形" class="headerlink" title="處理目錄名稱含有空白的情形"></a>處理目錄名稱含有空白的情形</h4><p>記得上一篇文章的使用說明中提到，若目錄名稱含有空白字元，則要使用 <code>&quot;&quot;</code> 圍住嗎？我們這個批次程式能正確處理目錄名稱含有空白字元這種狀況嗎？</p>
<p>同樣非常不幸運地，答案是否定的。問題是出現在 <code>:PARAMS</code> 副程序：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> &quot;FULL&quot; == &quot;<span class="variable">%%F</span>&quot; (</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>若在命令列輸入 <code>7z-bak &quot;C:\Program Files&quot;</code>，則這段程式碼展開之後，會變成：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> &quot;FULL&quot; == &quot;&quot;C:\Program Files&quot;&quot; (</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>意外的是，若將目標目錄寫在批次檔中，像這樣： <code>SRC_DIR=&quot;C:\Program Files&quot;</code>，則不會發生錯誤，可以正常執行。</p>
<p>此外，還有個小瑕疵：即使檔名沒有空白字元，若我們強行加上 <code>&quot;&quot;</code> 號圍住，則在顯示備份訊息時，會出現 <code>&quot;&quot;目錄名稱&quot;&quot;</code> 這樣的內容。譬如若在命令列輸入 <code>7z-bak &quot;C:\temp&quot;</code>，輸出訊息會是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Requesting diff backup for &quot;&quot;C:\temp&quot;&quot;...</span><br></pre></td></tr></table></figure>

<p>雖然可以正常執行，但是真的...很奇怪耶！你！</p>
<p>要解決這些問題，我們需要在適當的時候，將檔案名稱以 <code>&quot;&quot;</code> 圍住，適當的時候，又需要將它展開，去除 <code>&quot;&quot;</code>。</p>
<p>什麼時候需要圍住呢？在傳遞檔名時需要使用 <code>&quot;&quot;</code> 將檔名圍住，否則檔名將被拆開來解讀為兩個以上的參數。什麼時候需要展開呢？當我們需要重組檔名的時候，我們不希望檔名夾雜著多餘的或是不正確的 <code>&quot;</code> 號，譬如 <code>&quot;&quot;C:\Program Files&quot;&quot;</code> 及 <code>C:\&quot;Program Files&quot;</code>，在批次檔案裡面，就無法正確被解讀為檔案名稱。</p>
<p>要展開檔案名稱，可以使用前面提過的路徑參數處理語法，我們可以使用 <code>~f</code> 指令展開完整路徑：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="built_in">set</span> SRC_DIR=&quot;C:\Program Files&quot;, C:\&quot;Program Files&quot;, &quot;&quot;C:\Program Files&quot;&quot;</span><br><span class="line">  <span class="keyword">for</span> <span class="variable">%%F</span> <span class="keyword">in</span> (<span class="variable">%SRC_DIR%</span>) <span class="keyword">do</span> <span class="keyword">call</span> :SUB <span class="variable">%%F</span></span><br><span class="line">  <span class="keyword">goto</span> :END</span><br><span class="line">:SUB</span><br><span class="line">  <span class="built_in">echo</span> %<span class="number">1</span> expands to: %~f1</span><br><span class="line">:END</span><br></pre></td></tr></table></figure>

<p>輸出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;C:\Program Files&quot; expands to: C:\Program Files</span><br><span class="line">C:\&quot;Program Files&quot; expands to: C:\&quot;Program Files&quot;</span><br><span class="line">&quot;&quot;C:\Program expands to: D:\scripts\&quot;C:\Program</span><br><span class="line">Files&quot;&quot; expands to: D:\scripts\Files&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>注意，後面兩個路徑名稱，都無法被 <code>~f</code> 指令正確展開，第三個甚至連參數傳遞都不正確，被當作兩個參數傳遞了。</p>
<p>接下來，我們一一檢視哪些地方需要展開，哪些地方需要圍住：</p>
<p>主迴圈裡面呼叫副程序，備份目錄作為參數傳遞，所以不能在這裡展開，只要維持原樣：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for %%F in (%SRC_DIR%) do (</span><br><span class="line">  call :%TYPE% %%F</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>:FULL</code> 及 <code>:DIFF</code> 副程序，其中 <code>SRC</code> 接受參數之後，就不再更動，並且會被當作參數傳遞，所以可以直接在展開後立即圍住。而 <code>FN</code> 則需要做檔名重組，故只將它展開。<code>FB</code> 的狀況則與 <code>SRC</code> 類似，雖然在 <code>:DIFF</code> 中需要多次重新賦值：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">:FULL</span><br><span class="line">  <span class="built_in">SETLOCAL</span></span><br><span class="line">  <span class="built_in">set</span> SRC=&quot;%~f1&quot;</span><br><span class="line">  <span class="built_in">set</span> FN=%~nx1</span><br><span class="line">  <span class="built_in">echo</span> ------------------</span><br><span class="line">  <span class="built_in">echo</span> Requesting full backup <span class="keyword">for</span> <span class="variable">%SRC%</span>...</span><br><span class="line">  <span class="built_in">set</span> FB=&quot;<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span><span class="variable">%DATE%</span>.<span class="number">7</span>z&quot;</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">EXIST</span> <span class="variable">%FB%</span> (</span><br><span class="line">    <span class="built_in">echo</span> ...full backup <span class="keyword">for</span> <span class="variable">%SRC%</span>: <span class="variable">%FB%</span> already <span class="keyword">exist</span>, re-request diff backup instead...</span><br><span class="line">    <span class="keyword">call</span> :DO_DIFF_BAK <span class="variable">%SRC%</span> <span class="variable">%FB%</span></span><br><span class="line">  ) <span class="keyword">else</span> (</span><br><span class="line">    <span class="keyword">call</span> :DO_FULL_BAK <span class="variable">%SRC%</span> <span class="variable">%FB%</span></span><br><span class="line">  )</span><br><span class="line">  <span class="built_in">ENDLOCAL</span></span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br><span class="line"></span><br><span class="line">:DIFF</span><br><span class="line">  <span class="built_in">SETLOCAL</span></span><br><span class="line">  <span class="built_in">set</span> SRC=&quot;%~f1&quot;</span><br><span class="line">  <span class="built_in">set</span> FN=%~nx1</span><br><span class="line">  <span class="built_in">echo</span> ------------------</span><br><span class="line">  <span class="built_in">echo</span> Requesting diff backup <span class="keyword">for</span> <span class="variable">%SRC%</span>...</span><br><span class="line">  <span class="built_in">echo</span> ...finding full backup...</span><br><span class="line">  <span class="built_in">set</span> FB=</span><br><span class="line">  <span class="keyword">for</span> <span class="variable">%%N</span> <span class="keyword">in</span> (<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span>*.<span class="number">7</span>z) <span class="keyword">do</span> (</span><br><span class="line">    <span class="built_in">set</span> STMP=<span class="variable">%%N</span></span><br><span class="line">    <span class="built_in">set</span> STMP=<span class="variable">!STMP:~-11,8!</span></span><br><span class="line">    <span class="keyword">if</span> &quot;<span class="variable">%%N</span>&quot; == &quot;<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span><span class="variable">!STMP!</span>.<span class="number">7</span>z&quot; (</span><br><span class="line">      <span class="built_in">echo</span> ......found: &quot;<span class="variable">%%N</span>&quot;</span><br><span class="line">      <span class="built_in">set</span> FB=&quot;<span class="variable">%%N</span>&quot;</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">if</span> &quot;&quot; == &quot;<span class="variable">%FB%</span>&quot; (</span><br><span class="line">    <span class="built_in">echo</span> ...full backup <span class="keyword">not</span> found, re-request full backup instead...</span><br><span class="line">    <span class="built_in">set</span> FB=&quot;<span class="variable">%BAK<em>DIR%</em></span>\<span class="variable">%FN%</span><span class="variable">%DATE%</span>.<span class="number">7</span>z&quot;</span><br><span class="line">    <span class="keyword">call</span> :DO_FULL_BAK <span class="variable">%SRC%</span> <span class="variable">%FB%</span></span><br><span class="line">  ) <span class="keyword">else</span> (</span><br><span class="line">    <span class="built_in">echo</span> ...full backup found: <span class="variable">%FB%</span></span><br><span class="line">    <span class="keyword">call</span> :DO_DIFF_BAK <span class="variable">%SRC%</span> <span class="variable">%FB%</span></span><br><span class="line">  )</span><br><span class="line">  <span class="built_in">ENDLOCAL</span></span><br><span class="line">  <span class="keyword">goto</span> :eof</span><br></pre></td></tr></table></figure>

<p><code>:DO_FULL_BAK</code> 不需要更動，<code>:DO_DIFF_BAK</code> 則修正如下：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">:DO_DIFF_BAK</span><br><span class="line"> <span class="built_in">SETLOCAL</span></span><br><span class="line"> <span class="built_in">set</span> <span class="built_in">DIR</span>=&quot;%~f1&quot;</span><br><span class="line"> <span class="built_in">set</span> FULL=%~f2</span><br><span class="line"> <span class="built_in">set</span> DIFF=&quot;<span class="variable">%FULL:~0,-3%</span><em>diff</em><span class="variable">%DATE%</span>_<span class="variable">%TIME%</span>.<span class="number">7</span>z&quot;</span><br><span class="line"> <span class="built_in">echo</span> ...performing diff backup on &quot;<span class="variable">%FULL%</span>&quot;...</span><br><span class="line"> <span class="number">7</span>za u &quot;<span class="variable">%FULL%</span>&quot; <span class="variable">%Z_OPT%</span> -u- -up0q3r2x2y2z0w2^^!<span class="variable">%DIFF%</span> <span class="variable">%DIR%</span></span><br><span class="line"> <span class="built_in">echo</span> .</span><br><span class="line"> <span class="built_in">echo</span> ...<span class="variable">%DIFF%</span>...done^^!</span><br><span class="line"> <span class="built_in">ENDLOCAL</span></span><br><span class="line"> <span class="keyword">goto</span> :eof</span><br></pre></td></tr></table></figure>

<h3 id="完工"><a href="#完工" class="headerlink" title="完工"></a>完工</h3><p>終於看到辛苦的成果，感動啊！</p>
<!-- differential-backup-using-7-zip-windows-7z-bak.cmd -->
<!-- inno-v/5650722 -->
<script src="//gist.github.com/amobiz/d0be531a7c109c785845.js"></script>
<h3 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h3><p>之前對於批次檔的認識，一直停留在 DOS 3.X ~ 6.X 的時代，從來沒用過擴充功能。這次心血來潮，決定使用批次檔來呼叫 7-Zip 執行備份工作，說真的，實在是...自找罪受。Cmd 批次檔畢竟是 DOS 時代的遺物了，應該要跟上時代，改用 <a href="http://technet.microsoft.com/zh-tw/library/dd125460" title="Windows PowerShell" target="_blank" rel="external">Windows PowerShell</a>。</p>
<p>不論如何，最終還是完成了，也算是學到了一點東西，趁忘記之前，趕緊寫下這篇長篇大論，以資紀念及備查。</p>
<p>歡迎大家的回饋與心得分享。</p>
<h3 id="參考資料："><a href="#參考資料：" class="headerlink" title="參考資料："></a>參考資料：</h3><ul>
<li><a href="http://www.dotnetperls.com/7-zip-examples" title="7-Zip Command-Line" target="_blank" rel="external">7-Zip Command-Line</a></li>
<li><a href="http://a32.me/2010/08/7zip-differential-backup-linux-windows/" title="Automated differential backup using 7zip for linux/windows" target="_blank" rel="external">Automated differential backup using 7zip for linux/windows</a></li>
<li><a href="http://en.wikipedia.org/wiki/Batch_file" title="batch" target="_blank" rel="external">Batch file</a></li>
<li><a href="http://ss64.com/nt/syntax-functions.html" title="Batch file Functions" target="_blank" rel="external">Batch file Functions</a></li>
<li><a href="http://stackoverflow.com/questions/3288552/how-can-i-escape-an-exclamation-mark-in-cmd-scripts" title="How can I escape an exclamation mark ! in cmd scripts?" target="_blank" rel="external">How can I escape an exclamation mark ! in cmd scripts?</a></li>
<li><a href="http://stackoverflow.com/questions/203090/how-to-get-current-datetime-on-windows-command-line-in-a-suitable-format-for-us/203116#203116" title="How to get current datetime on windows command line, in a suitable format for using in a filename?" target="_blank" rel="external">How to get current datetime on windows command line, in a suitable format for using in a filename?</a></li>
<li><a href="http://ss64.com/nt/syntax-filenames.html" title="Long filenames, NTFS and legal filename characters" target="_blank" rel="external">Long filenames, NTFS and legal filename characters</a></li>
<li><a href="http://ss64.com/nt/syntax-args.html" title="Parameters" target="_blank" rel="external">Parameters</a></li>
<li><a href="http://stackoverflow.com/questions/203090/how-to-get-current-datetime-on-windows-command-line-in-a-suitable-format-for-us/1951681#1951681" title="Regionaly independent date time parsing" target="_blank" rel="external">Regionaly independent date time parsing</a></li>
<li><a href="http://ss64.com/nt/set.html" title="SET" target="_blank" rel="external">SET</a></li>
<li><a href="http://ss64.com/nt/setlocal.html" title="SETLOCAL" target="_blank" rel="external">SETLOCAL</a></li>
<li><a href="http://www.robvanderwoude.com/variableexpansion.php" title="Variable Expansion in FOR Loops" target="_blank" rel="external">Variable Expansion in FOR Loops</a></li>
<li><a href="http://ss64.com/nt/syntax-substring.html" title="Variables: extract part of a variable (substring)" target="_blank" rel="external">Variables: extract part of a variable (substring)</a></li>
<li><a href="http://ss64.com/nt/syntax-wildcards.html" title="Wildcards" target="_blank" rel="external">Wildcards</a></li>
</ul>
<h3 id="相關文章："><a href="#相關文章：" class="headerlink" title="相關文章："></a>相關文章：</h3><!-- cross references -->
<div><ul>
<li><a href="/2012/07/20/differential-backup-using-7-zip-part1-windows/" title="Differential backup using 7-Zip for Windows (Part 1) - 利用 7-Zip 進行差異備份（上篇）">Differential backup using 7-Zip for Windows (Part 1) - 利用 7-Zip 進行差異備份（上篇）</a></li>
<li><a href="/2012/07/22/differential-backup-using-7-zip-part2-secrets-of-batch-files/" title="Differential backup using 7-Zip for Windows (Part 2) - Secrets of batch files - 利用 7-Zip 進行差異備份（下篇） - 批次檔案的秘密">Differential backup using 7-Zip for Windows (Part 2) - Secrets of batch files - 利用 7-Zip 進行差異備份（下篇） - 批次檔案的秘密</a></li>
</ul>
</div>
<!-- external references -->

      
    </div>
    <footer class="article-footer">
      <a data-url="https://amobiz.github.io/2012/07/22/differential-backup-using-7-zip-part2-secrets-of-batch-files/" data-id="cj4y12uaz005cu556ukn04cjf" class="article-share-link">Share</a>
      
        <a href="https://amobiz.github.io/2012/07/22/differential-backup-using-7-zip-part2-secrets-of-batch-files/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/7-Zip/">7-Zip</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Backup/">Backup</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Batch/">Batch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Windows/">Windows</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cmd/">cmd</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/howto/">howto</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pitfalls/">pitfalls</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2013/05/28/blogger-google-code-prettify-github-gist/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          在 Blogger 上用 Google Code Prettify 及 GitHub Gist 顯示程式碼 (不修改範本的懶人招數)
        
      </div>
    </a>
  
  
    <a href="/2012/07/20/differential-backup-using-7-zip-part1-windows/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Differential backup using 7-Zip for Windows (Part 1) - 利用 7-Zip 進行差異備份（上篇）</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  
    <ul class="nav"></ul>
  
  
    <section class="comments" title="Disqus">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </section>
  
  
    <section class="comments" title="Facebook">
      <div class="fb-comments" data-href="https://amobiz.github.io/2012/07/22/differential-backup-using-7-zip-part2-secrets-of-batch-files/" data-width="100%" data-numposts="5"></div>
    </section>
  
</section>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hack/">Hack</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Productivity/">Productivity</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Programming/">Programming</a><span class="category-list-count">36</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Software/">Software</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web-Design/">Web Design</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/7-Zip/">7-Zip</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AMD/">AMD</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AMP/">AMP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/APP2SD/">APP2SD</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AngularJS/">AngularJS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Atom/">Atom</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BEM/">BEM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Backup/">Backup</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Batch/">Batch</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blogger/">Blogger</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS-modules/">CSS-modules</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CommonJS/">CommonJS</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DIY/">DIY</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Design-Pattern/">Design Pattern</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ESLint/">ESLint</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Facebook-Notes/">Facebook Notes</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GTD/">GTD</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Generator/">Generator</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ginger-yoshi/">Ginger yoshi</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gist/">Gist</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub/">GitHub</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Google/">Google</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Google-App-Engine/">Google App Engine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Google-Code-Prettify/">Google Code Prettify</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Grails/">Grails</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Groovy/">Groovy</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gulp/">Gulp</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JAX-RS/">JAX-RS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDOM/">JDOM</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JSHint/">JSHint</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JSON/">JSON</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jersey/">Jersey</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jetty/">Jetty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Logdown/">Logdown</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/">Markdown</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maven/">Maven</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Medium/">Medium</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NPM/">NPM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Namespace/">Namespace</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Open-Source/">Open Source</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pomodoro-Technique/">Pomodoro Technique</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Programming/">Programming</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Promise/">Promise</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Regular-Expression/">Regular Expression</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RequireJS/">RequireJS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SUIT/">SUIT</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SWAP/">SWAP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shadow-DOM/">Shadow DOM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TagSoup/">TagSoup</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Time-Management/">Time Management</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/">Tomcat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UMD/">UMD</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/URL/">URL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web-Components/">Web Components</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/">Webpack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XML/">XML</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XPath/">XPath</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yeoman/">Yeoman</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/advertising/">advertising</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/best-practices/">best practices</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/browser/">browser</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cheatsheet/">cheatsheet</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cmd/">cmd</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/component/">component</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/">css</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/custom-ROM/">custom ROM</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dfp/">dfp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/doubleclick/">doubleclick</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/doubleclick-for-publishers/">doubleclick for publishers</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/glob/">glob</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gpt/">gpt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/howto/">howto</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lint/">lint</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linter/">linter</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linter-eslint/">linter-eslint</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/modular-css/">modular css</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/modularity/">modularity</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/normalize/">normalize</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/normalizer/">normalizer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/notes/">notes</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm/">npm</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/open-source/">open source</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pitfalls/">pitfalls</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/productivity/">productivity</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/regex/">regex</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rooted/">rooted</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/svn/">svn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/time-management/">time management</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tutorial/">tutorial</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/7-Zip/" style="font-size: 11.25px;">7-Zip</a> <a href="/tags/AMD/" style="font-size: 11.25px;">AMD</a> <a href="/tags/AMP/" style="font-size: 10px;">AMP</a> <a href="/tags/APP2SD/" style="font-size: 11.25px;">APP2SD</a> <a href="/tags/Android/" style="font-size: 13.75px;">Android</a> <a href="/tags/AngularJS/" style="font-size: 10px;">AngularJS</a> <a href="/tags/Atom/" style="font-size: 10px;">Atom</a> <a href="/tags/BEM/" style="font-size: 10px;">BEM</a> <a href="/tags/Backup/" style="font-size: 11.25px;">Backup</a> <a href="/tags/Batch/" style="font-size: 11.25px;">Batch</a> <a href="/tags/Blogger/" style="font-size: 12.5px;">Blogger</a> <a href="/tags/CSS-modules/" style="font-size: 10px;">CSS-modules</a> <a href="/tags/CommonJS/" style="font-size: 15px;">CommonJS</a> <a href="/tags/DIY/" style="font-size: 13.75px;">DIY</a> <a href="/tags/Design-Pattern/" style="font-size: 12.5px;">Design Pattern</a> <a href="/tags/ESLint/" style="font-size: 10px;">ESLint</a> <a href="/tags/Facebook-Notes/" style="font-size: 10px;">Facebook Notes</a> <a href="/tags/GTD/" style="font-size: 10px;">GTD</a> <a href="/tags/Generator/" style="font-size: 10px;">Generator</a> <a href="/tags/Ginger-yoshi/" style="font-size: 11.25px;">Ginger yoshi</a> <a href="/tags/Gist/" style="font-size: 10px;">Gist</a> <a href="/tags/GitHub/" style="font-size: 16.25px;">GitHub</a> <a href="/tags/Google/" style="font-size: 10px;">Google</a> <a href="/tags/Google-App-Engine/" style="font-size: 10px;">Google App Engine</a> <a href="/tags/Google-Code-Prettify/" style="font-size: 10px;">Google Code Prettify</a> <a href="/tags/Grails/" style="font-size: 10px;">Grails</a> <a href="/tags/Groovy/" style="font-size: 12.5px;">Groovy</a> <a href="/tags/Gulp/" style="font-size: 11.25px;">Gulp</a> <a href="/tags/HTML/" style="font-size: 13.75px;">HTML</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/JAX-RS/" style="font-size: 10px;">JAX-RS</a> <a href="/tags/JDOM/" style="font-size: 12.5px;">JDOM</a> <a href="/tags/JSHint/" style="font-size: 10px;">JSHint</a> <a href="/tags/JSON/" style="font-size: 10px;">JSON</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/Jersey/" style="font-size: 10px;">Jersey</a> <a href="/tags/Jetty/" style="font-size: 10px;">Jetty</a> <a href="/tags/Logdown/" style="font-size: 10px;">Logdown</a> <a href="/tags/Markdown/" style="font-size: 11.25px;">Markdown</a> <a href="/tags/Maven/" style="font-size: 16.25px;">Maven</a> <a href="/tags/Medium/" style="font-size: 10px;">Medium</a> <a href="/tags/NPM/" style="font-size: 10px;">NPM</a> <a href="/tags/Namespace/" style="font-size: 11.25px;">Namespace</a> <a href="/tags/Open-Source/" style="font-size: 11.25px;">Open Source</a> <a href="/tags/Pomodoro-Technique/" style="font-size: 10px;">Pomodoro Technique</a> <a href="/tags/Programming/" style="font-size: 10px;">Programming</a> <a href="/tags/Promise/" style="font-size: 11.25px;">Promise</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/Regular-Expression/" style="font-size: 15px;">Regular Expression</a> <a href="/tags/RequireJS/" style="font-size: 10px;">RequireJS</a> <a href="/tags/SUIT/" style="font-size: 10px;">SUIT</a> <a href="/tags/SWAP/" style="font-size: 10px;">SWAP</a> <a href="/tags/Shadow-DOM/" style="font-size: 10px;">Shadow DOM</a> <a href="/tags/TagSoup/" style="font-size: 12.5px;">TagSoup</a> <a href="/tags/Time-Management/" style="font-size: 10px;">Time Management</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/UMD/" style="font-size: 11.25px;">UMD</a> <a href="/tags/URL/" style="font-size: 10px;">URL</a> <a href="/tags/Web-Components/" style="font-size: 10px;">Web Components</a> <a href="/tags/Webpack/" style="font-size: 10px;">Webpack</a> <a href="/tags/Windows/" style="font-size: 11.25px;">Windows</a> <a href="/tags/XML/" style="font-size: 12.5px;">XML</a> <a href="/tags/XPath/" style="font-size: 12.5px;">XPath</a> <a href="/tags/Yeoman/" style="font-size: 12.5px;">Yeoman</a> <a href="/tags/advertising/" style="font-size: 10px;">advertising</a> <a href="/tags/best-practices/" style="font-size: 10px;">best practices</a> <a href="/tags/browser/" style="font-size: 10px;">browser</a> <a href="/tags/cheatsheet/" style="font-size: 11.25px;">cheatsheet</a> <a href="/tags/cmd/" style="font-size: 11.25px;">cmd</a> <a href="/tags/component/" style="font-size: 10px;">component</a> <a href="/tags/css/" style="font-size: 10px;">css</a> <a href="/tags/custom-ROM/" style="font-size: 11.25px;">custom ROM</a> <a href="/tags/dfp/" style="font-size: 10px;">dfp</a> <a href="/tags/doubleclick/" style="font-size: 10px;">doubleclick</a> <a href="/tags/doubleclick-for-publishers/" style="font-size: 10px;">doubleclick for publishers</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/glob/" style="font-size: 10px;">glob</a> <a href="/tags/gpt/" style="font-size: 10px;">gpt</a> <a href="/tags/howto/" style="font-size: 18.75px;">howto</a> <a href="/tags/lint/" style="font-size: 11.25px;">lint</a> <a href="/tags/linter/" style="font-size: 10px;">linter</a> <a href="/tags/linter-eslint/" style="font-size: 10px;">linter-eslint</a> <a href="/tags/modular-css/" style="font-size: 11.25px;">modular css</a> <a href="/tags/modularity/" style="font-size: 10px;">modularity</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/nodejs/" style="font-size: 13.75px;">nodejs</a> <a href="/tags/normalize/" style="font-size: 10px;">normalize</a> <a href="/tags/normalizer/" style="font-size: 10px;">normalizer</a> <a href="/tags/notes/" style="font-size: 11.25px;">notes</a> <a href="/tags/npm/" style="font-size: 13.75px;">npm</a> <a href="/tags/open-source/" style="font-size: 13.75px;">open source</a> <a href="/tags/pitfalls/" style="font-size: 17.5px;">pitfalls</a> <a href="/tags/productivity/" style="font-size: 10px;">productivity</a> <a href="/tags/regex/" style="font-size: 15px;">regex</a> <a href="/tags/rooted/" style="font-size: 11.25px;">rooted</a> <a href="/tags/svn/" style="font-size: 10px;">svn</a> <a href="/tags/time-management/" style="font-size: 10px;">time management</a> <a href="/tags/tutorial/" style="font-size: 11.25px;">tutorial</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">七月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">十二月 2013</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">十一月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">七月 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">六月 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/03/">三月 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/02/">二月 2011</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/12/">十二月 2010</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/08/11/react-dfp/">埋設 DFP - DoubleClick for Publishers 廣告</a>
          </li>
        
          <li>
            <a href="/2016/04/22/modular-css-notes/">Modular CSS</a>
          </li>
        
          <li>
            <a href="/2016/04/15/angularjs-1.5-best-practices/">AngularJS 1.5 最佳實務</a>
          </li>
        
          <li>
            <a href="/2016/04/07/re-npm-left-pad-have-we-forgotten-how-to-program/">反駁：NPM &amp; left-pad: Have We Forgotten How To Program?</a>
          </li>
        
          <li>
            <a href="/2016/03/09/npm-package-node-or-browser/">如何判斷 npmjs.com 上的套件，是否支援 node 或 browser</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Amobiz Chen<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'amobiz';
  
  var disqus_url = 'https://amobiz.github.io/2012/07/22/differential-backup-using-7-zip-part2-secrets-of-batch-files/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



<div id="fb-root"></div>

<!-- Facebook SDK -->
<script>
(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v2.5&appId=1660468744166033";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script>
<!-- End Facebook SDK -->




<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/script.js"></script>
<script src="/js/nav.js"></script>

  </div>
</body>
</html>